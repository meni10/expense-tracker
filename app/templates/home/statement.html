{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}

<div class="shadow-card" style="padding: 20px;">
    <h1>All Statements</h1>

    <div style="margin-bottom: 2rem;">
        <a href="{{ url_for('Home.home_index') }}">&lt;&lt; Back to Home</a>
    </div>

    <!-- Summary Section -->
    <div>
        <p><strong>Current Balance:</strong> {{ current_balance | round(2) }}</p>
        <p><strong>Total Income:</strong> {{ total_income | round(2) }}</p>
        <p><strong>Total Expense:</strong> {{ total_expense | round(2) }}</p>
    </div>

    <!-- Charts -->
    <h2>Monthly Income vs Expense</h2>
    <canvas id="monthlyChart" width="600" height="300"></canvas>

    <h2>Expense by Category</h2>
    <canvas id="expensePieChart" width="600" height="300"></canvas>

    <!-- List of recent statements -->
    <h2 style="margin-top: 3rem;">Recent Statements</h2>
    <ul>
        {% for s in statements %}
        <li>
            <strong>{{ s.at }}</strong> - {{ s.desc }} : 
            <span style="color: {{ 'green' if s.amount >= 0 else 'red' }}">
                {{ s.amount }}
            </span>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
async function fetchChartData() {
  const response = await fetch('/chart-data');
  return await response.json();
}

function createMonthlyChart(ctx, months, income, expense) {
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [
        {
          label: 'Income',
          data: income,
          borderColor: 'green',
          backgroundColor: 'rgba(0,128,0,0.1)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'Expense',
          data: expense,
          borderColor: 'red',
          backgroundColor: 'rgba(255,0,0,0.1)',
          fill: true,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function createExpensePieChart(ctx, categories, amounts) {
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: categories,
      datasets: [{
        data: amounts,
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
        ]
      }]
    },
    options: { responsive: true }
  });
}

(async () => {
  const data = await fetchChartData();

  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  createMonthlyChart(monthlyCtx, data.monthly.months, data.monthly.income, data.monthly.expense);

  const pieCtx = document.getElementById('expensePieChart').getContext('2d');
  createExpensePieChart(pieCtx, data.expense_by_desc.categories, data.expense_by_desc.amounts);
})();
</script>

{% endblock %}
